# Описание
telegram-bot, выполняющий роль RAG-агента при помощи YandexGPT из [YandexCloud](https://github.com/yandex-cloud/yandex-cloud-ml-sdk/)

## Идея бота
Логика бота выстроена следующим способом: 
- Пользователь делает запрос, связанный с вашей логикой наполнения документов (в примере указан помощник по выбору курорта по странам)
- Agent ищет релевантный документ исходя из вашего запроса
- YandexGPT формирует красивый ответ, учитывая базовый промпт, заданный внутри класса Agent:
```Python
    def _build_prompt(self, query: str, context_chunks: List[str]) -> str:
        """Формирование промпта с контекстом"""
        context = "\n\n".join(
            f"Контекст {i + 1}:\n{chunk}"
            for i, chunk in enumerate(context_chunks)
        ) if context_chunks else "Контекст не найден"

        return f"""
        Ты - бот, который помогает пользователям выбрать страну для путешествий. Ты рекомендуешь страны, основываясь на интересных фактах, достопримечательностях, местных традициях и уникальных особенностях. В каждом ответе ты должны красиво описывать страну, упоминать её культуру, природу, популярные места для посещения, а также советы для путешественников.

        Пример ответа:
        1. **Италия** — страна, которая очарует тебя с первого взгляда! Вдохни воздух Рима, наслаждайся винами Тосканы и заблуди на узких улочках Венеции. Ты не можешь пропустить Колизей и Ватикан, а также обязательно попробуй местное мороженое и пасту. В Италии каждый уголок — это настоящая история, и путешествия здесь будут захватывающими и незабываемыми!
        
        Не забывай упоминать о:
        - Природных красотах (горы, пляжи, озера)
        - Местных традициях и кухне
        - Популярных местах для активного отдыха (экскурсии, пешие маршруты, пляжи)
        - добавляй флаги в ответ страны, которую предлагаешь
        - если пользователь не знает что именно выбрать, то предложи ему несколько стран
        - добавляй смайлики для красивого ответа
        - добавляй в ответ фразы по типу : "я бы тебе порекомендовал" и тп


        {context}

        Вопрос: {query}

        Ответ (будь точны, но не обязательно кратким):
        """
```

Выбор модели осуществляется путем прямой передачи в параметры конструктора Agent:
```Python
class Agent:
    def __init__(
            self,
            yandex_folder_id: str,
            yandex_api_key: str,
            document_loader: DocumentLoader,
            vector_db: VectorDB,
            model_name: str = "yandexgpt",
            model_version: str = "rc"
    ):
        self.document_loader = document_loader
        self.vector_db = vector_db
        self._init_models(yandex_folder_id, yandex_api_key, model_name, model_version)
        self._load_knowledge_base()
```
- Выбрать можно любую из допустимых на YandexCloud, включая open-source`ные модели

## Технический стек
| Компонент               | Версия            | Назначение                                                                 |
|-------------------------|-------------------|---------------------------------------------------------------------------|
| aiogram                 | 2.25.1            | Асинхронный фреймворк для создания Telegram-ботов                         |
| yandex-cloud-ml-sdk     | -                 | Работа с моделями Yandex Cloud AI (включая все доступные модели YC)       |
| chromadb                | >=0.4.0           | Векторная база данных для хранения и поиска эмбеддингов                   |
| markdown               | -                 | Парсинг и генерация Markdown-контента                                     |
| beautifulsoup4          | -                 | Парсинг HTML/XML (например, для веб-скрейпинга)                           |
| redis                   | >=4.5.0           | Кеширование и временное хранение запросов                                   |
| confluent-kafka         | >=2.0.2           | Работа с Apache Kafka (асинхронная обработка событий/сообщений)           |
| python-dotenv           | -                 | Загрузка переменных окружения из `.env` файлов                            |
| numpy                   | -                 | Математические операции и работа с массивами                              |
| asyncio                 | -                 | Асинхронное программирование                                              |
| dotenv                  | -                 | Альтернатива для работы с переменными окружения                           |

## Запуск
Создать .env файл, в котором необходимо указать следующее:
>- TELEGRAM_TOKEN - токен вашего бота, полученного через @BotFather
>- YANDEX_FOLDER_ID - название каталога на YandexCloud CLI, в котором размещена модель
>- YANDEX_API_KEY - API сервисного аккаунта в каталоге, со всеми необходимыми разрешениями(см. [документацию](https://yandex.cloud/ru/docs/foundation-models/sdk/))

- Запустить Docker desktop либо docker иначе
- docker-compose up -d --build

После чего логирование вашего приложения можно отслеживать напрямую в логах контейнеров.

## Если что-то пошло не так
Версии библиотек могут ругаться, в частности встречается следующая проблема:
- После установки yandex-sdk необходимо обновить некоторые библиотеки:
```Python
pip install --upgrade --quiet yandex-cloud-ml-sdk
pip install --quiet flit
pip install --quiet -I git+https://github.com/yandex-cloud/yandex-cloud-ml-sdk.git@assistants_fc#egg=yandex-cloud-ml-sdk
pip install --upgrade --quiet pydantic
```